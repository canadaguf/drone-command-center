# Production configuration for autonomous drone client

# MAVLink configuration
mavlink:
  connection: "/dev/ttyAMA0"
  baud: 256000
  takeoff_altitude: 1.5  # Default takeoff altitude in meters (AGL - Above Ground Level)
  takeoff_min_pitch: 10.0  # Minimum pitch angle for takeoff (degrees, typically 10-15)

# Backend configuration
backend:
  ws_url: "wss://drone-command-center.onrender.com/ws?client=drone"
  reconnect_interval: 5

# Vision configuration
vision:
  model_path: "/home/ilya/models/yolo11n.onnx"
  input_size: 320
  confidence: 0.5
  target_fps: 25

# Camera configuration
camera:
  width: 640
  height: 480
  fps: 30
  fov_horizontal: 120
  fov_vertical: 90

# Tracking configuration
tracking:
  distance_modes:
    close: 2.0
    medium: 4.0
    far: 6.0
  default_mode: "medium"
  
  altitude:
    auto_adjust: true
    target_altitude: 1.5  # Target altitude in meters (will be maintained dynamically)
    base_hover_throttle: 50  # Base throttle for hover (calibrate for your drone - typically 40-60)
    min_height: 0.5
    max_height: 2.0
  
  lost_target:
    hover_timeout: 2.0
    land_timeout: 10.0
  
  # Safety configuration (SPF-inspired improvements)
  safety:
    yaw_only_threshold: 2.0  # Distance (meters) below which only yaw commands are sent (no forward movement)
    obstacle_threshold_forward: 1.5  # Forward obstacle detection threshold (meters) - prevents forward movement
    obstacle_threshold_down: 0.5  # Downward obstacle/ground detection threshold (meters) - triggers climb
    emergency_stop_threshold: 0.8  # Emergency stop threshold (meters) - immediate stop if obstacle closer
  
  # Advanced following features (inspired by ArduPilot GSOC 2024 Visual Follow-Me)
  advanced:
    velocity_prediction: true       # Enable velocity-based predictive following for smoother tracking
    smooth_following: true          # Enable smoothing filter to reduce oscillations

# TOF sensors configuration
tof_sensors:
  multiplexer_address: 0x70
  sensors:
    - name: "forward"
      channel: 0
      direction: "front"
      max_range: 4.0
    - name: "down"
      channel: 1
      direction: "down"
      max_range: 4.0
  # Easy to add more sensors:
  # - name: "left"
  #   channel: 2
  #   direction: "left"
  #   max_range: 4.0
  # - name: "right"
  #   channel: 3
  #   direction: "right"
  #   max_range: 4.0
  # - name: "back"
  #   channel: 4
  #   direction: "back"
  #   max_range: 4.0

# Safety configuration
safety:
  battery:
    warn_percent: 30
    critical_percent: 20
    auto_land_percent: 15
  
  rc_override:
    detection_enabled: true
    threshold: 100
    neutral_timeout: 2.0
  
  geofence:
    enabled: false
    max_altitude: 50
    max_distance: 100

# PID controller gains
pid_gains:
  yaw:
    kp: 0.5
    ki: 0.0
    kd: 0.1
  pitch:
    kp: 0.3
    ki: 0.0
    kd: 0.05
  roll:
    kp: 0.3
    ki: 0.0
    kd: 0.05
  distance:
    kp: 0.2
    ki: 0.0
    kd: 0.1
  altitude:
    kp: 15.0  # Proportional gain for altitude control (higher = more responsive)
    ki: 0.5   # Integral gain (helps eliminate steady-state error)
    kd: 5.0   # Derivative gain (dampens oscillations)

# Altitude reference configuration
altitude_reference:
  auto_capture: true        # Automatically capture altitude reference when armed
  lift_off_threshold: 0.2   # Minimum altitude AGL to consider lifted off (meters)
  
# Flight mode configuration
flight_modes:
  takeoff:
    throttle_start: 45      # Starting throttle percentage for gradual takeoff (minimum to maintain lift)
    throttle_increment: 2   # Throttle increase per step (percentage) - used for fallback
    throttle_max: 70        # Maximum throttle during takeoff (percentage)
    update_interval: 0.1    # Update interval in seconds (10 Hz)
    target_height: 1.5      # Target takeoff height in meters (AGL - Above Ground Level)
    height_tolerance: 0.05  # Height tolerance in meters (5cm) - takeoff completes when within this range
    kp: 15.0                # Proportional gain for height control (throttle = base + kp * height_error)
  
  landing:
    throttle_decrement: 1.5          # Throttle decrease per step (percentage) - gradual descent
    min_throttle: 45                 # Minimum throttle to maintain until ground contact (prevents falling)
    detection_distance: 0.05         # Height AGL to consider landed (0.05m = 5cm)
    detection_tolerance: 0.01        # Tolerance for landing detection (1cm)
    update_interval: 0.1             # Update interval in seconds (10 Hz)
    ground_contact_throttle: 0       # Throttle when ground contact detected (0 = motors off)
  
  stabilization:
    hover_throttle: 50      # Hover throttle percentage (maintains altitude)
    update_interval: 0.1    # Update interval in seconds (10 Hz)

# VLM configuration (optional)
vlm:
  enabled: false
  provider: "gemini"
  model: "gemini-2.0-flash"
  api_key: "${GEMINI_API_KEY}"

# Logging configuration
logging:
  level: "INFO"
  file: "/var/log/drone_client.log"
  max_size_mb: 50
